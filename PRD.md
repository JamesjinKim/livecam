# PRD (Product Requirements Document) - 라즈베리파이 CCTV 시스템

## 📋 문서 정보
- **버전**: 2.1 ⚡
- **작성일**: 2025-09-08
- **마지막 업데이트**: 2025-09-11 (UI 개선 및 종료 처리 개선)
- **대상 시스템**: 듀얼 카메라 CCTV 스트리밍 + 모션 감지 블랙박스
- **플랫폼**: Raspberry Pi 5, Python 3
- **주요 변경**: 웹 UI 레이아웃 개선, 프레임 수 초기화 로직 추가, Ctrl+C 종료 처리 개선

---

## 🎯 Part 1: CCTV 실시간 스트리밍 시스템 ⚡

### 🚀 2025.09 Picamera2 마이그레이션 완료

**마이그레이션 성과**:
- ✅ **안정성 대폭 향상**: rpicam-vid 서브프로세스 방식의 장기 스트리밍 중 멈춤 현상 완전 해결
- ✅ **성능 향상**: CPU 사용률 20-30% 감소, 메모리 효율성 향상
- ✅ **하드웨어 가속**: Pi5 VideoCore VII GPU + PiSP BCM2712_D0 직접 활용
- ✅ **UI 완전성**: 기존 cctv_main.py의 모든 기능과 UI 100% 보존
- ✅ **하트비트 모니터링**: 실시간 스트림 상태 감지 시스템 통합
- ✅ **웹/백엔드 분리**: 코드 보호를 위한 모듈화 구조 지원 (2025.09.11 추가) ⭐

### 1.1 시스템 개요

#### 목적
라즈베리파이 5 기반 듀얼 카메라 CCTV 시스템으로, 웹 브라우저를 통한 실시간 영상 모니터링 및 카메라 제어 기능 제공
**2025.09**: Picamera2 라이브러리 기반 GPU 직접 액세스로 장기 안정성 확보
**2025.09.11**: 웹/백엔드 분리 구조로 코드 보호 및 모듈화 지원 ⭐

#### 핵심 가치 제안
- **다중 클라이언트 지원**: 해상도별 최대 2명 동시 접속 (2025.09.10 업그레이드)
- **듀얼 카메라 토글**: 리소스 효율적인 카메라 전환
- **모듈화 아키텍처**: 웹/백엔드 분리로 코드 보호 지원 (2025.09.11 추가) ⭐
- **실시간 웹 스트리밍**: 브라우저 기반 즉시 접근
- **해상도 동적 변경**: 네트워크 환경에 따른 최적화
- ⚡ **Picamera2 GPU 가속**: 서브프로세스 제거로 Zero-latency 처리
- ❤️ **하트비트 모니터링**: 실시간 스트림 상태 및 품질 감시
- 💚 **직관적 UI**: 일관된 버튼 레이아웃 및 대칭 정렬
- 🔄 **메모리 안정성**: 10만 프레임마다 자동 초기화
- ⚡ **즉시 종료**: Ctrl+C 입력 시 카메라 정리 후 즉시 종료

### 1.2 기술 아키텍처

#### 현재 운영 중인 시스템 (2025.09.11 기준)
- **📦 통합 버전**: `picam2_main.py` (기존 운영용)
- **🔧 분리 버전**: `picam2_webmain.py` (코드 보호 대비용) ⭐ 신규

#### 시스템 구성도 (공통)
```
┌─────────────────────────────────────────────────────────────┐
│                    CCTV 스트리밍 시스템                        │
├─────────────────────────────────────────────────────────────┤
│  웹 브라우저 (Client)                                          │
│  └─ HTML5 + JavaScript (실시간 UI)                           │
├─────────────────────────────────────────────────────────────┤
│  FastAPI 웹 서버 (Port 8001)                                 │
│  ├─ REST API (카메라 제어, 해상도 변경)                        │
│  ├─ MJPEG 스트리밍 엔드포인트                                  │
│  └─ 단일 클라이언트 세션 관리                                  │
├─────────────────────────────────────────────────────────────┤
│  Picamera2 직접 GPU 액세스 ⚡                                 │
│  ├─ Camera 0 (OV5647) - 라이브러리 직접 호출                    │
│  ├─ Camera 1 (OV5647) - 라이브러리 직접 호출                    │
│  └─ VideoCore VII + PiSP BCM2712_D0 하드웨어 가속           │
├─────────────────────────────────────────────────────────────┤
│  하드웨어 레이어                                               │
│  └─ Raspberry Pi 5 + Dual Camera Module                    │
└─────────────────────────────────────────────────────────────┘
```

#### 기술 스택 (2025.09 업그레이드)
- **백엔드**: FastAPI, Python 3.11+
- **카메라 엔진**: ⚡ **Picamera2 라이브러리** (서브프로세스 제거)
- **스트리밍**: MJPEG over HTTP + HEAD 메서드 지원
- **하드웨어 가속**: VideoCore VII + **PiSP BCM2712_D0** 직접 활용
- **프론트엔드**: Vanilla JavaScript, HTML5 + 하트비트 모니터링
- **네트워크**: HTTP/1.1, 포트 8001

### 1.3 핵심 기능 명세

#### 1.3.1 실시간 스트리밍
**기능**: 단일 클라이언트 MJPEG 스트리밍 (Picamera2 기반) ⚡
```python
# Picamera2 직접 구현 (서브프로세스 제거)
@app.api_route("/stream", methods=["GET", "HEAD"])
async def video_stream(request: Request):
    if request.method == "HEAD":  # 하트비트 지원
        return Response(status_code=200 if camera_active else 503)
    
    # Picamera2 직접 JPEG 캡처 (GPU 가속)
    return StreamingResponse(generate_mjpeg_stream(), 
                           media_type="multipart/x-mixed-replace")
```

**성능 요구사항** (Picamera2 실측) ⚡:
- 480p: 30fps, ~31KB/frame (640×480)
- 720p: 30fps, ~109KB/frame (1280×720) **개선됨**
- 지연시간: **< 200ms** (60% 개선)
- 메모리 사용: **< 60MB** (40% 감소)
- CPU 사용률: **20-30% 절약**

#### 1.3.2 듀얼 카메라 토글
**기능**: 실시간 카메라 전환 (Picamera2 인스턴스 관리) ⚡
```python
def start_camera_stream(camera_id: int):
    # Picamera2 직접 인스턴스 생성 (서브프로세스 제거)
    picam2 = Picamera2(camera_num=camera_id)
    config = picam2.create_video_configuration(
        main={"size": (width, height), "format": "YUV420"}
    )
    picam2.configure(config)
    picam2.start()  # 즉시 GPU 가속 시작
```

**전환 시간**: **< 1초** (3배 향상)
**안정성**: 좀비 프로세스 원천 차단, GPU 메모리 직접 관리

#### 1.3.3 동적 해상도 변경
**지원 해상도**:
- **480p**: 640×480 (기본)
- **720p**: 1280×720

**최적화 파라미터**:
| 해상도 | 청크 크기 | 버퍼 한계 | 프레임 크기 범위 |
|--------|-----------|-----------|------------------|
| 480p   | 16KB      | 512KB     | 2-200KB         |
| 720p   | 32KB      | 2MB       | 5-500KB         |

#### 1.3.4 단일 클라이언트 관리
**세션 관리**:
- IP 기반 클라이언트 추적
- 최대 1개 동시 연결
- 423 Locked HTTP 응답
- 자동 세션 정리

### 1.4 웹 인터페이스

#### UI 컴포넌트 (2025.09 업그레이드)
- **라이브 스트림 뷰어**: 전체 화면 활용
- **카메라 토글 버튼**: Camera 0 ↔ Camera 1
- **해상도 선택**: 480p / 720p
- **실시간 통계**: FPS, 프레임 수, 평균 크기
- ❤️ **하트비트 인디케이터**: LIVE/DELAY/ERROR/OFFLINE 상태 표시
- **일관된 디자인**: 모든 버튼 통일된 스타일

#### 반응형 디자인
```css
/* 모던 그레이 톤 디자인 */
background: #f5f5f5;
accent-color: #007bff; /* 파란색 액센트 */
```

### 1.5 성능 최적화

#### 스트리밍 최적화 (Picamera2 기반) ⚡
- **GPU 직접 액세스**: 서브프로세스 오버헤드 완전 제거
- **Zero-copy 스트림**: Picamera2 → BytesIO 직접 전송
- **하드웨어 버퍼링**: Pi5 자체 버퍼링 시스템 활용
- **PiSP 가속**: Image Signal Processor BCM2712_D0 활용
- **인스턴스 관리**: 메모리 누수 방지

#### 네트워크 최적화
- **청크 단위 전송**: 16KB/32KB 청크
- **HTTP Keep-Alive**: 연결 재사용
- **압축 품질**: MJPEG 80% 품질

### 1.6 보안 및 안정성

#### 보안 요소
- **IP 기반 접근 제어**: 내부 네트워크 권장
- **단일 세션 제한**: DDoS 방지
- **프로세스 격리**: subprocess 독립 실행

#### 안정성 보장
- **자동 복구**: 스트림 오류 시 재시도
- **리소스 정리**: 프로세스 완전 종료
- **에러 핸들링**: 상세한 로그 및 상태 표시

### 1.7 배포 및 운영

#### 시스템 요구사항
- **하드웨어**: Raspberry Pi 5, OV5647 카메라 ×2
- **OS**: Raspberry Pi OS (64-bit)
- **Python**: 3.11+
- **네트워크**: 10Mbps+ (720p 기준)

#### 실행 방법 (2025.09)
```bash
# Picamera2 기반 CCTV 실행
python3 picam2_main.py

# 레거시 (참고용)
# python3 cctv_main.py  # 구버전 (rpicam-vid)

# 접속 URL
http://라즈베리파이_IP:8001
```

#### 모니터링 (2025.09 강화)
- **실시간 통계**: 웹 UI 통계 패널
- ❤️ **하트비트 모니터링**: 2초마다 스트림 상태 자동 체크
- **로그 분석**: 콘솔 출력 + PiSP 하드웨어 로그
- **성능 지표**: FPS, 메모리 사용량, GPU 활용률

---

## 🔄 Part 2: 모션 감지 블랙박스 시스템 (detection_cam0.py, detection_cam1.py)

### 2.1 시스템 개요

#### 목적
OpenCV 기반 지능형 모션 감지 시스템으로, 이벤트 기반 영상 녹화 및 저장을 통한 블랙박스 기능 제공

평상시 운영 관점에서 스토리텔링을 해보면 
1.라즈베리리파이가 켜지면
   detection_cam0,1이 동작하여 디텍션을 감시합니다. 이벤트에 반응하여        30초(prebuffer 5sec포함) mp4가 저장됩니다.
2.사용자가 원격지에서 main.py를 실행합니다. 웹으로 접속을 시도합니다. 
3.시스템은 detection_cam0,1의 프로세스를 모두 종료하고 사용자의 cctv기능을  사용할 수 있도록 main.py를 통해 웹 ui를 제공합니다.
4.사용자는 디텍 이벤트로 생성된 저당 mp4를 조회하고, 실제 cctv를 통해 현재 상황을 실시간으로 분석합니다. (이 순서는 바뀔뀔수 있음)
5.사용자가 cctv를 종료합니다. => 6.시스템은 사용자 cctv 종료 후 자동으로 detection_cam0,1을 실행하여 blackbox 가동을 시작합니다.

💼 비즈니스 가치
  사용자 관점:
  - 🚀 즉시 사용: 원격 접속 시 바로 CCTV 사용 가능
  - 🔄 자동 관리: 수동 개입 없는 완전 자동화
  - 📱 사용자 친화적: 웹 브라우저만으로 모든 제어
  - 🛡️ 안전 보장: CCTV 종료 후 자동으로 감시 모드 복귀

  시스템 관점:
  - 🎯 자원 효율: 카메라 경합 없는 완벽한 자원 관리
  - 🔒 보안 강화: 빈틈없는 감시 체계
  - ⚡ 고가용성: 24/7 안정적 서비스 보장

#### 핵심 가치 제안
- **스마트 모션 감지**: OpenCV BackgroundSubtractorMOG2 알고리즘
- **프리버퍼 시스템**: 모션 발생 이전 5초 영상 포함
- **이벤트 기반 녹화**: 30초 고정 영상 (5초 프리 + 25초 포스트)
- **날짜별 자동 분류**: YYMMDD 폴더 구조로 체계적 저장

### 2.2 기술 아키텍처

#### 시스템 구성도
```
┌─────────────────────────────────────────────────────────────┐
│               모션 감지 블랙박스 시스템                        │
├─────────────────────────────────────────────────────────────┤
│  Motion Detection Engine                                    │
│  ├─ OpenCV BackgroundSubtractorMOG2                        │
│  ├─ 민감도 레벨 관리 (very_low ~ very_high)                 │
│  └─ 쿨다운 시스템 (12초)                                     │
├─────────────────────────────────────────────────────────────┤
│  Pre-buffer System                                         │
│  ├─ 5초 순환 버퍼 (50 프레임 @ 10fps)                       │
│  ├─ JPEG 인코딩 메모리 효율                                  │
│  └─ 프레임 복제 (10fps → 30fps)                            │
├─────────────────────────────────────────────────────────────┤
│  Recording System                                          │
│  ├─ rpicam-vid 기반 H.264 녹화                             │
│  ├─ ffmpeg 영상 병합                                        │
│  └─ 30초 고정 길이 보장                                      │
├─────────────────────────────────────────────────────────────┤
│  Storage Management                                         │
│  ├─ 날짜별 폴더 (YYMMDD)                                    │
│  ├─ 자동 파일명 생성                                         │
│  └─ 임시 파일 정리                                          │
├─────────────────────────────────────────────────────────────┤
│  Hardware Layer                                            │
│  └─ Raspberry Pi 5 + Camera Module                        │
└─────────────────────────────────────────────────────────────┘
```

#### 핵심 컴포넌트
```python
# 주요 클래스 구조
├── MotionDetectionSystem (메인 조정자)
├── CameraStreamManager (카메라 스트림 관리)
├── SimpleMotionDetector (모션 감지 알고리즘)
├── VideoRecorder (프리버퍼 + 녹화 시스템)
├── EventManager (이벤트 로깅)
└── Config (설정 관리)
```

### 2.3 모션 감지 알고리즘

#### 감지 방식
- **알고리즘**: OpenCV BackgroundSubtractorMOG2
- **배경 안정화**: 60프레임 학습 (2초)
- **변화 임계값**: 픽셀 단위 변화량 측정
- **노이즈 제거**: 가우시안 블러 + 형태학적 연산

#### 민감도 레벨 (조절가능)
| 레벨      | 임계값   | 쿨다운 | 설명 |
|------    |-------- |--------|------|
| very_low | 15000px | 15s    | 사람이 화면을 거의 다 가로질러야 감지 |
| low      | 10000px | 12s    | 팔 전체를 크게 흔들 때 정도 감지 (기본) |
| medium   | 6000px  | 8s     | 팔이나 손 전체가 움직일 때만 감지 |
| high     | 3000px  | 5s     | 손가락 등 작은 물체 움직임도 감지 |
| very_high | 1000px | 3s     | 미세한 변화, 노이즈까지 감지 |

### 2.4 프리버퍼 시스템

#### 기술 구현
```python
# 5초 순환 버퍼
self.actual_buffer_fps = 30 // 3  # 10fps (skip_frames 고려)
self.frame_buffer = deque(maxlen=5 * 10)  # 50 프레임

# 프레임 복제로 정확한 5초 구현
for _ in range(3):  # 10fps → 30fps 변환
    out.write(frame_resized)
```

#### 메모리 최적화
- **JPEG 압축**: 85% 품질로 메모리 효율
- **순환 버퍼**: 고정 크기로 메모리 누수 방지
- **실시간 상태**: 버퍼 용량 실시간 표시

### 2.5 녹화 시스템

#### 영상 구성
- **프리버퍼**: 5초 (모션 감지 이전)
- **포스트버퍼**: 25초 (모션 감지 이후)
- **총 길이**: 정확히 30초

#### 병합 프로세스
```bash
# ffmpeg 병합 명령어
ffmpeg -f concat -safe 0 -i list.txt \
  -c:v libx264 -preset fast \
  -t 30 -r 30 -pix_fmt yuv420p \
  -y output.mp4
```

#### 품질 보장
- **Duration 검증**: 실제 30초 확인
- **프레임레이트 통일**: 30fps 고정
- **해상도**: 1280×720 업스케일

### 2.6 저장 관리 시스템

#### 폴더 구조
```
videos/motion_events/
├── cam0/
│   ├── 250908/  # 2025년 9월 8일
│   │   ├── motion_event_cam0_20250908_143025.mp4
│   │   └── motion_event_cam0_20250908_151200.mp4
│   └── 250909/  # 2025년 9월 9일
│       └── ...
└── cam1/
    ├── 250908/
    └── 250909/
```

#### 파일명 규칙
- **형식**: `motion_event_cam{N}_{YYYYMMDD}_{HHMMSS}.mp4`
- **예시**: `motion_event_cam0_20250908_143025.mp4`

### 2.7 성능 및 안정성

#### 성능 지표
- **CPU 사용률**: ~15-20% (단일 카메라, 720p)
- **메모리 사용**: ~50-60MB
- **저장 용량**: ~5-6MB/30초 영상
- **감지 지연**: < 100ms

#### 안정성 보장
- **프로세스 정리**: SIGTERM → SIGKILL 순차 종료
- **백그라운드 스레드**: daemon=False로 정상 종료
- **임시 파일 관리**: 자동 정리 시스템
- **오류 복구**: 스트림 재시작 메커니즘

### 2.8 운영 및 모니터링

#### 실행 방법
```bash
# Camera 0 모션 감지
python3 detection_cam0.py

# Camera 1 모션 감지
python3 detection_cam1.py
```

#### 실시간 로그
```
Motion detected: 21701 changed pixels
🎬 Motion Event Recording Started
  Pre-buffer: 5s (from circular buffer)
  Post-buffer: 25s (new recording)
  Expected total: 30s
✅ Video merged successfully: 250908/motion_event_cam0_20250908_143025.mp4
  - File size: 5.6MB
  - Final duration: 30.0s (expected: 30s, diff: 0.0s)
  ✓ Pre-buffer successfully included in final video
```

#### 설정 최적화
- **민감도 조절**: `CURRENT_SENSITIVITY = 'low'`
- **쿨다운 시간**: 환경에 따른 조절 가능
- **해상도 변경**: `RECORDING_WIDTH`, `RECORDING_HEIGHT`

---

## 📊 전체 시스템 통합

### 시스템 간 관계
- **독립 운영**: CCTV와 모션 감지 시스템 분리 실행
- **리소스 공유**: 동일한 카메라 하드웨어 활용
- **상호 보완**: 실시간 모니터링 + 이벤트 기록

### 권장 운영 방식 (2025.09 업데이트)
1. **일반 모니터링**: ⚡ CCTV 시스템(`picam2_main.py`) 상시 실행
2. **보안 강화**: 야간 또는 부재 시 모션 감지 시스템 추가 실행
3. **저장소 관리**: 정기적인 영상 파일 백업 및 정리
4. **24/7 안정성**: Picamera2 기반으로 장기 운영 보장

### 향후 확장성
- **통합 대시보드**: 두 시스템을 통합한 웹 인터페이스
- **알림 시스템**: 모션 감지 시 실시간 알림
- **클라우드 연동**: 자동 백업 및 원격 접근