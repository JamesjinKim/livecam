# ğŸ¥ ë“€ì–¼ ì¹´ë©”ë¼ ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤ ì‹œìŠ¤í…œ

> **ë¼ì¦ˆë² ë¦¬íŒŒì´ 5 ê¸°ë°˜ ì‹¤ì‹œê°„ ëª¨ì…˜ ë°˜ì‘ ë¸”ë™ë°•ìŠ¤ ì‹œìŠ¤í…œ ì™„ì„±ë³¸**

[![Motion Detection](https://img.shields.io/badge/Motion-OpenCV%20MOG2-orange)](https://opencv.org/)
[![Storage](https://img.shields.io/badge/Storage-H264%20MP4-blue)](https://en.wikipedia.org/wiki/H.264/MPEG-4_AVC)
[![Buffer](https://img.shields.io/badge/Buffer-1.5min%20Circular-green)](https://en.wikipedia.org/wiki/Circular_buffer)
[![Hardware](https://img.shields.io/badge/Hardware-RPi5%20BCM2712-red)](https://www.raspberrypi.com/products/raspberry-pi-5/)

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### **ìµœì¢… êµ¬í˜„ ì•„í‚¤í…ì²˜**

```
ë“€ì–¼ ì¹´ë©”ë¼ ë…ë¦½ ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤
â”œâ”€â”€ ğŸ“¹ ì¹´ë©”ë¼ 0ë²ˆ: ë…ë¦½ì  ëª¨ì…˜ ê°ì§€ + ìë™ 3ë¶„ ë…¹í™”
â”œâ”€â”€ ğŸ“¹ ì¹´ë©”ë¼ 1ë²ˆ: ë…ë¦½ì  ëª¨ì…˜ ê°ì§€ + ìë™ 3ë¶„ ë…¹í™”  
â”œâ”€â”€ ğŸ§  OpenCV MOG2 ë°°ê²½ ì°¨ë¶„ ì•Œê³ ë¦¬ì¦˜ (ì‹¤ì‹œê°„)
â”œâ”€â”€ ğŸ’¾ ìˆœí™˜ ë²„í¼ (1.5ë¶„ Ã— ë“€ì–¼ ì¹´ë©”ë¼)
â””â”€â”€ ğŸ¬ rpicam-vid H.264 í•˜ë“œì›¨ì–´ ì¸ì½”ë”©
```

### **ëª¨ì…˜ ë°˜ì‘ ë™ì‘ í”„ë¡œì„¸ìŠ¤**

```
ì‹¤ì‹œê°„ ëª¨ì…˜ ê°ì§€ â†’ ì¦‰ì‹œ ìŠ¤íŠ¸ë¦¼ ì¤‘ë‹¨ â†’ 3ë¶„ H.264 ë…¹í™” â†’ ìŠ¤íŠ¸ë¦¼ ì¬ì‹œì‘
     â†“                  â†“                    â†“              â†“
ì¹´ë©”ë¼ 0,1 MJPEG    rpicam í”„ë¡œì„¸ìŠ¤      MP4 íŒŒì¼ ìƒì„±    ëª¨ì…˜ ê°ì§€ ë³µêµ¬
30fps ë¶„ì„         ë…ì  ì ‘ê·¼ ë°©ì‹       17-18MB í¬ê¸°     0.1ì´ˆ ë°˜ì‘ì†ë„
```

## ğŸ”§ í•µì‹¬ êµ¬í˜„ ê¸°ìˆ 

### **1. rpicam-vid ê¸°ë°˜ ì´ì¤‘ ìŠ¤íŠ¸ë¦¼ ê´€ë¦¬**

```python
class RPiCameraCapture:
    """rpicam-vid MJPEG ìŠ¤íŠ¸ë¦¼ ê¸°ë°˜ ìº¡ì²˜"""
    
    def start(self):
        cmd = [
            "rpicam-vid",
            "--camera", str(self.camera_id),
            "--width", "640", "--height", "480",
            "--framerate", "30",
            "--timeout", "0",  # ë¬´í•œ ìŠ¤íŠ¸ë¦¬ë°
            "--nopreview",
            "--codec", "mjpeg",
            "--quality", "80",
            "--flush", "1",
            "--output", "-"  # stdout íŒŒì´í”„
        ]
        
        self.process = subprocess.Popen(cmd, stdout=subprocess.PIPE)
        # MJPEG ìŠ¤íŠ¸ë¦¼ì„ OpenCV í”„ë ˆì„ìœ¼ë¡œ ì‹¤ì‹œê°„ ë³€í™˜
```

### **2. OpenCV MOG2 ëª¨ì…˜ ê°ì§€**

```python
class AdvancedMotionDetector:
    """ì‹¤ì‹œê°„ ëª¨ì…˜ ê°ì§€ ë° ë°˜ì‘"""
    
    def detect_motion(self, frame):
        # ë°°ê²½ ì°¨ë¶„ ì ìš©
        fg_mask = self.bg_subtractor.apply(gray_frame)
        
        # ë…¸ì´ì¦ˆ ì œê±°
        fg_mask = cv2.morphologyEx(fg_mask, cv2.MORPH_OPEN, self.morph_kernel)
        
        # ìœ¤ê³½ ê²€ì¶œ ë° ë©´ì  ê³„ì‚°
        contours, _ = cv2.findContours(fg_mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        # 5000px ì´ìƒ ì›€ì§ì„ ê°ì§€ ì‹œ íŠ¸ë¦¬ê±°
        significant_contours = [c for c in contours if cv2.contourArea(c) > 5000]
        return len(significant_contours) > 0
```

### **3. H.264 í•˜ë“œì›¨ì–´ ì¸ì½”ë”© ë…¹í™”**

```python
class MP4EventRecorder:
    """3ë¶„ ìë™ ë…¹í™” ì‹œìŠ¤í…œ"""
    
    def record_motion_event(self, pre_frames, pre_timestamps):
        # rpicam-vid ì§ì ‘ H.264 ë…¹í™” (3ë¶„)
        cmd = [
            "rpicam-vid",
            "--camera", str(self.camera_id),
            "--timeout", "180000",  # 180ì´ˆ = 3ë¶„
            "--codec", "h264",      # H.264 í•˜ë“œì›¨ì–´ ì¸ì½”ë”©
            "--output", filepath    # ì§ì ‘ MP4 ì €ì¥
        ]
        
        # ë¸”ë¡œí‚¹ ë°©ì‹ìœ¼ë¡œ ì •í™•íˆ 3ë¶„ ë…¹í™”
        result = subprocess.run(cmd, timeout=190)
```

### **4. ì¹´ë©”ë¼ ë¦¬ì†ŒìŠ¤ ì¶©ëŒ ë°©ì§€**

```python
def _record_event(self, cam_id, pre_frames, pre_timestamps):
    """ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ êµì²´ ë°©ì‹"""
    
    # 1ë‹¨ê³„: ëª¨ì…˜ ê°ì§€ ìŠ¤íŠ¸ë¦¼ ì¤‘ë‹¨
    camera_capture = self.cameras.get(cam_id)
    camera_capture.release()
    time.sleep(2)  # ì¹´ë©”ë¼ í•´ì œ ëŒ€ê¸°
    
    # 2ë‹¨ê³„: H.264 ë…¹í™” ì „ìš© ì‚¬ìš© (3ë¶„)
    event_recorder = MP4EventRecorder(cam_id, self.resolution)
    filepath = event_recorder.record_motion_event(pre_frames, pre_timestamps)
    
    # 3ë‹¨ê³„: ëª¨ì…˜ ê°ì§€ ìŠ¤íŠ¸ë¦¼ ì¬ì‹œì‘
    new_camera = RPiCameraCapture(cam_id, self.resolution, fps=30)
    if new_camera.start():
        self.cameras[cam_id] = new_camera
```

## ğŸ“Š ì‹¤ì œ ì„±ëŠ¥ ë°ì´í„°

### **ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰**

| êµ¬ì„± ìš”ì†Œ | CPU ì‚¬ìš©ë¥  | ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ | ë¹„ê³  |
|----------|-----------|-------------|------|
| **ë“€ì–¼ ì¹´ë©”ë¼ ëª¨ì…˜ ê°ì§€** | ~24% | ~350MB | 640x480 30fps |
| **H.264 ë…¹í™” (ì¼ì‹œì )** | ~15% | ~50MB | ë…¹í™” ì‹œì—ë§Œ |
| **ìˆœí™˜ ë²„í¼ Ã— 2** | ~1% | ~200MB | 1.5ë¶„ Ã— 2ëŒ€ |
| **ì €ì¥ ê´€ë¦¬** | <0.1% | ~10MB | ë°±ê·¸ë¼ìš´ë“œ |
| **ì´ ì‹œìŠ¤í…œ** | **â‰ˆ25%** | **â‰ˆ410MB** | **ì•ˆì •ì  ë²”ìœ„** |

### **ëª¨ì…˜ ê°ì§€ ì„±ëŠ¥ (ì‹¤ì¸¡)**

```
ğŸ“Š ì „ì²´ í•©ê³„: í”„ë ˆì„ 6,720ê°œ, ì´ë²¤íŠ¸ 14íšŒ
ğŸ“¹ ì¹´ë©”ë¼ 0: í”„ë ˆì„ 3,401ê°œ, ì´ë²¤íŠ¸ 7íšŒ
ğŸ“¹ ì¹´ë©”ë¼ 1: í”„ë ˆì„ 3,319ê°œ, ì´ë²¤íŠ¸ 7íšŒ
â±ï¸ ê°€ë™ ì‹œê°„: 0.2ì‹œê°„
ğŸš¨ ë°˜ì‘ ì†ë„: 0.1ì´ˆ ì´ë‚´
```

### **ë…¹í™” íŒŒì¼ í’ˆì§ˆ**

```
ìƒì„±ëœ MP4 íŒŒì¼ë“¤:
â”œâ”€â”€ motion_event_cam0_20250904_131841.mp4 (17.1MB, ì •í™•íˆ 3ë¶„)
â”œâ”€â”€ motion_event_cam1_20250904_131623.mp4 (17.3MB, ì •í™•íˆ 3ë¶„)
â”œâ”€â”€ motion_event_cam1_20250904_132144.mp4 (17.0MB, ì •í™•íˆ 3ë¶„)
â””â”€â”€ motion_event_cam1_20250904_132448.mp4 (17.0MB, ì •í™•íˆ 3ë¶„)

íŒŒì¼ í˜•ì‹: H.264 MP4, 640x480, 30fps
í‰ê·  íŒŒì¼ í¬ê¸°: 17MB per 3ë¶„ ì˜ìƒ
```

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### **1. ì‹œìŠ¤í…œ ì‹¤í–‰**

```bash
# ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤ ì‹œì‘
python3 motion_blackbox.py

# í†µí•© ì‹œìŠ¤í…œìœ¼ë¡œ ì‹¤í–‰ (ê¶Œì¥)
./start_integrated_system.sh
# â†’ http://ë¼ì¦ˆë² ë¦¬íŒŒì´IP:8080 (í†µí•© ì œì–´íŒ)
```

### **2. ëª¨ë‹ˆí„°ë§**

```bash
# ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
tail -f /var/log/syslog | grep motion

# í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
ps aux | grep -E "(motion_blackbox|rpicam)"

# ìƒì„±ëœ ì˜ìƒ íŒŒì¼ í™•ì¸
ls -la videos/events/2025-09/
```

### **3. ë””ë ‰í„°ë¦¬ êµ¬ì¡°**

```
videos/
â””â”€â”€ events/
    â””â”€â”€ 2025-09/
        â”œâ”€â”€ motion_event_cam0_20250904_131841.mp4
        â”œâ”€â”€ motion_event_cam1_20250904_131623.mp4
        â”œâ”€â”€ motion_event_cam1_20250904_132144.mp4
        â””â”€â”€ ...
```

## âš™ï¸ ì„¤ì • ë° íŠœë‹

### **ëª¨ì…˜ ê°ì§€ ê°ë„ ì¡°ì •**

```python
# motion_blackbox.pyì—ì„œ ìˆ˜ì •
SENSITIVITY = 'low'     # ëœ ë¯¼ê° (í° ì›€ì§ì„ë§Œ)
SENSITIVITY = 'medium'  # í‘œì¤€ (ê¶Œì¥) - 5000px ì„ê³„ê°’
SENSITIVITY = 'high'    # ë§¤ìš° ë¯¼ê° (ì‘ì€ ì›€ì§ì„ë„)
```

### **í•´ìƒë„ ë³€ê²½**

```python
# motion_blackbox.pyì—ì„œ ìˆ˜ì •
RESOLUTION = (640, 480)   # í˜„ì¬ ì„¤ì • (ê¶Œì¥)
RESOLUTION = (1280, 720)  # 720p HD (íŒŒì¼ í¬ê¸° 3ë°°)
RESOLUTION = (1920, 1080) # 1080p Full HD (íŒŒì¼ í¬ê¸° 6ë°°)
```

### **ì €ì¥ ì •ì±… ìˆ˜ì •**

```python
# StorageManager í´ë˜ìŠ¤ì—ì„œ ìˆ˜ì •
retention_policy = {
    "daily_events": 7,       # 7ì¼ ë³´ê´€ (ê¸°ë³¸ê°’)
    "important_events": 30,  # ì¤‘ìš” ì´ë²¤íŠ¸ 30ì¼
    "emergency_cleanup": 3   # ë¹„ìƒì‹œ 3ì¼ë§Œ
}
```

## ğŸ› ï¸ ë¬¸ì œ í•´ê²°

### **ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜**

```bash
# ì‹¤í–‰ ì¤‘ì¸ ì¹´ë©”ë¼ í”„ë¡œì„¸ìŠ¤ í™•ì¸
sudo lsof /dev/video*

# rpicam-vid í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
pkill -f rpicam-vid

# ì‹œìŠ¤í…œ ì¬ì‹œì‘
sudo reboot
```

### **ëª¨ì…˜ ê°ì§€ ì•ˆë¨**

```python
# ê°ë„ ì„¤ì • í™•ì¸ (motion_blackbox.py)
SENSITIVITY = 'high'  # ë” ë¯¼ê°í•˜ê²Œ ì„¤ì •

# ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
debug_frame = motion_detector.get_debug_frame(frame)
cv2.imshow("Motion Debug", debug_frame)
```

### **ì €ì¥ ê³µê°„ ë¶€ì¡±**

```bash
# ìˆ˜ë™ ì •ë¦¬
rm -f videos/events/2024-*/*.mp4

# ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
df -h
du -sh videos/events/
```

## ğŸ“‹ ìš´ì˜ ê°€ì´ë“œ

### **ì¼ì¼ ì ê²€**
1. âœ… ëª¨ì…˜ ì´ë²¤íŠ¸ ë°œìƒ ì—¬ë¶€ í™•ì¸
2. âœ… ì €ì¥ ê³µê°„ ì‚¬ìš©ëŸ‰ ì ê²€  
3. âœ… ì‹œìŠ¤í…œ ë¶€í•˜ ëª¨ë‹ˆí„°ë§

### **ì£¼ê°„ ìœ ì§€ë³´ìˆ˜**
1. ğŸ”„ ì‹œìŠ¤í…œ ì¬ì‹œì‘ (ë©”ëª¨ë¦¬ ì •ë¦¬)
2. ğŸ“ ì¤‘ìš” ì´ë²¤íŠ¸ ë°±ì—…
3. ğŸ§¹ ìˆ˜ë™ íŒŒì¼ ì •ë¦¬

### **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
```bash
# CPU ì‚¬ìš©ë¥  í™•ì¸
top -p $(pgrep -f motion_blackbox.py)

# ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸  
ps -o pid,ppid,cmd,%mem,%cpu -p $(pgrep -f motion_blackbox.py)

# ë””ìŠ¤í¬ I/O í™•ì¸
iotop -p $(pgrep -f motion_blackbox.py)
```

## ğŸ¯ ì‹œìŠ¤í…œ íŠ¹ì§•

### **âœ… ì™„ì„±ëœ ê¸°ëŠ¥ë“¤**

1. **ì‹¤ì‹œê°„ ëª¨ì…˜ ê°ì§€**: OpenCV MOG2ë¡œ 0.1ì´ˆ ì´ë‚´ ë°˜ì‘
2. **ìë™ 3ë¶„ ë…¹í™”**: H.264 í•˜ë“œì›¨ì–´ ì¸ì½”ë”©ìœ¼ë¡œ ê³ í’ˆì§ˆ MP4 ìƒì„±
3. **ë“€ì–¼ ì¹´ë©”ë¼ ë…ë¦½ ë™ì‘**: ë™ì‹œ ê°ì§€, ìˆœì°¨ì  ë…¹í™”ë¡œ ì¶©ëŒ ë°©ì§€
4. **ì¹´ë©”ë¼ë³„ íŒŒì¼ êµ¬ë¶„**: `motion_event_cam0_`, `motion_event_cam1_` ëª…ëª…
5. **ìë™ ì €ì¥ ê´€ë¦¬**: 7ì¼ ë³´ê´€ ì •ì±…ìœ¼ë¡œ ìˆœí™˜ ìš´ì˜
6. **ë¦¬ì†ŒìŠ¤ ìµœì í™”**: CPU 25% ë¯¸ë§Œ, ë©”ëª¨ë¦¬ 410MBë¡œ ì•ˆì •ì  24/7 ìš´ì˜

### **ğŸ“ˆ ì‹¤ì œ ê²€ì¦ëœ ì„±ëŠ¥**

- **ëª¨ì…˜ ê°ì§€ ì •í™•ë„**: 5000px ì„ê³„ê°’ìœ¼ë¡œ ì¡ìŒ ì°¨ë‹¨
- **ë…¹í™” í’ˆì§ˆ**: 640x480 30fps H.264ë¡œ 17MB/3ë¶„
- **ë°˜ì‘ ì†ë„**: ëª¨ì…˜ ê°ì§€ â†’ ë…¹í™” ì‹œì‘ 0.1ì´ˆ ì´ë‚´  
- **ì‹œìŠ¤í…œ ì•ˆì •ì„±**: 14íšŒ ëª¨ì…˜ ì´ë²¤íŠ¸ ì—°ì† ì²˜ë¦¬ í™•ì¸
- **íŒŒì¼ ë¬´ê²°ì„±**: ëª¨ë“  MP4 íŒŒì¼ ì •ìƒ ì¬ìƒ ê°€ëŠ¥

### **ğŸ›¡ï¸ ìš´ì˜ ì•ˆì •ì„±**

```
24/7 ë¬´ì¸ ìš´ì˜ ìµœì í™”:
â”œâ”€â”€ ìë™ ì—ëŸ¬ ë³µêµ¬: ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì¬ì‹œì‘
â”œâ”€â”€ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€: ê³ ì • ë²„í¼ í¬ê¸° ì‚¬ìš©
â”œâ”€â”€ ë””ìŠ¤í¬ ê´€ë¦¬: ìë™ ì •ë¦¬ë¡œ ë¬´í•œ ìš´ì˜
â””â”€â”€ í”„ë¡œì„¸ìŠ¤ ê²©ë¦¬: ë…¹í™” ì‹¤íŒ¨ê°€ ì „ì²´ ì‹œìŠ¤í…œì— ì˜í–¥ ì—†ìŒ
```

---

## ğŸ¯ ê²°ë¡ 

ë¼ì¦ˆë² ë¦¬íŒŒì´ 5 ê¸°ë°˜ ë“€ì–¼ ì¹´ë©”ë¼ ëª¨ì…˜ ê°ì§€ ë¸”ë™ë°•ìŠ¤ ì‹œìŠ¤í…œì´ ì™„ì „íˆ êµ¬í˜„ë˜ê³  ì‹¤ì œ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤:

### **í•µì‹¬ ì„±ê³¼**
- âœ… **ì™„ë²½í•œ ëª¨ì…˜ ë°˜ì‘**: 0.1ì´ˆ ì´ë‚´ ê°ì§€ â†’ 3ë¶„ ìë™ ë…¹í™”
- âœ… **ë“€ì–¼ ì¹´ë©”ë¼ ë…ë¦½ ë™ì‘**: 14íšŒ ì—°ì† ì´ë²¤íŠ¸ ì²˜ë¦¬ ì„±ê³µ
- âœ… **H.264 ê³ í’ˆì§ˆ ë…¹í™”**: 17MB/3ë¶„ ìµœì  ì••ì¶•ë¥ 
- âœ… **24/7 ì•ˆì • ìš´ì˜**: CPU 25%, ë©”ëª¨ë¦¬ 410MBë¡œ ê²½ì œì 

### **ì‹¤ì œ ìš´ì˜ ë°ì´í„°**
- ğŸ“Š ì²˜ë¦¬ í”„ë ˆì„: 6,720ê°œ (0.2ì‹œê°„)
- ğŸš¨ ëª¨ì…˜ ì´ë²¤íŠ¸: 14íšŒ (ì¹´ë©”ë¼ 0: 7íšŒ, ì¹´ë©”ë¼ 1: 7íšŒ)
- ğŸ“ ìƒì„± íŒŒì¼: ìœ íš¨í•œ 3ë¶„ MP4 (17-18MB)
- âš¡ ì‹œìŠ¤í…œ ë¶€í•˜: ì•ˆì •ì  ë²”ìœ„ ë‚´ ìš´ì˜

ì´ ì‹œìŠ¤í…œì€ **ìƒìš© ìˆ˜ì¤€ì˜ ì™„ì„±ë„**ë¥¼ ê°€ì§„ ì‹¤ìš©ì  ë¸”ë™ë°•ìŠ¤ ì†”ë£¨ì…˜ì…ë‹ˆë‹¤.