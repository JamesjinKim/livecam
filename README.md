# 🎥 듀얼 카메라 토글 스트리밍 시스템

> **라즈베리파이 5 기반 실시간 카메라 전환 및 스트리밍 시스템**

[![Platform](https://img.shields.io/badge/Platform-Raspberry%20Pi%205-red)](https://www.raspberrypi.org/)
[![Camera](https://img.shields.io/badge/Camera-OV5647%20Dual-blue)](https://www.uctronics.com/)
[![Streaming](https://img.shields.io/badge/Streaming-MJPEG%2030fps-green)](https://en.wikipedia.org/wiki/Motion_JPEG)
[![UI](https://img.shields.io/badge/UI-Responsive%20Web-yellow)](https://fastapi.tiangolo.com/)

## 📌 시스템 개요

라즈베리파이 5 기반 듀얼 카메라 토글 스트리밍 시스템으로 **실시간 카메라 전환**, **다중 해상도 지원**, **반응형 웹 인터페이스**를 제공합니다.

### ✨ 주요 특징
- 🔄 **실시간 카메라 토글** - 카메라 0번/1번 즉시 전환
- 📺 **다중 해상도 지원** - 480p(640×480), 720p(1280×720) 
- 🎯 **30fps 고품질 스트리밍** - MJPEG 80% 품질, 하드웨어 최적화
- 🌐 **반응형 웹 UI** - 전체 화면 활용, 해상도별 영역 최적화
- 💻 **실시간 모니터링** - FPS, 프레임 수, 스트림 상태 표시
- ⚡ **저부하 운영** - 단일 카메라 전환으로 시스템 부하 최소화

## 🚀 빠른 시작

### 1단계: 의존성 설치
```bash
# 시스템 패키지 설치
sudo apt update
sudo apt install -y rpicam-apps python3-venv

# Python 가상환경 설정
python3 -m venv venv
source venv/bin/activate
pip install fastapi uvicorn psutil
```

### 2단계: 카메라 확인
```bash
# 연결된 카메라 목록 확인
rpicam-hello --list-cameras

# 카메라 0번 테스트 (2초)
rpicam-hello --camera 0 --timeout 2000

# 카메라 1번 테스트 (2초)
rpicam-hello --camera 1 --timeout 2000
```

### 3단계: 스트리밍 서버 실행
```bash
python main.py
```

### 4단계: 웹 브라우저에서 접속
```
http://라즈베리파이_IP:8001
```

## 🎮 사용 방법

### 📱 웹 인터페이스 기능

#### 카메라 전환
- **카메라 0** / **카메라 1** 버튼으로 즉시 전환
- 선택된 카메라는 **그린**으로 표시
- 선택되지 않은 카메라는 **화이트 그레이**로 표시

#### 해상도 변경
- **480p (640×480)** - 컴팩트한 70% 폭 영역
- **720p (1280×720)** - 큰 95% 폭 영역
- 해상도별 영역 크기 자동 조정

#### 실시간 상태 모니터링
- **활성 카메라**: 현재 스트리밍 중인 카메라 번호
- **해상도**: 현재 설정된 해상도
- **FPS**: 실시간 프레임레이트
- **프레임 수**: 총 처리된 프레임 수
- **평균 프레임 크기**: 프레임당 평균 데이터 크기
- **스트림 상태**: 연결 상태 (스트리밍 중/연결 끊김/대기 중)

### 🛠️ 고급 설정

#### rpicam-vid 최적화 파라미터
```bash
rpicam-vid --camera 0 --width 640 --height 480 \
  --timeout 0 --nopreview --codec mjpeg \
  --quality 80 --framerate 30 --bitrate 0 \
  --denoise cdn_fast --flush 1 --hflip --output -
```

**핵심 최적화 기술**:
- **768KB 고정 버퍼**: 메모리 누수 방지 및 30fps 처리량 보장
- **3단계 버퍼 풀**: 순환 버퍼 관리로 지연 최소화
- **적응형 청크 읽기**: 32KB/16KB 청크로 프레임 드롭 방지
- **인라인 JPEG 검색**: memoryview 직접 사용으로 복사 오버헤드 제거
- **하드웨어 디노이징**: `cdn_fast`로 품질 향상

## 📊 성능 사양

### CPU 사용률 (라즈베리파이 5 기준)

| 해상도 | 스트리밍 FPS | CPU 사용률 | 메모리 사용량 | 프레임 크기 |
|--------|-------------|-----------|-------------|------------|
| **480p** | 30fps | ~0.3% | ~50MB | 15-25KB |
| **720p** | 30fps | ~0.3% | ~52MB | 40-80KB |

### 해상도별 영역 크기

| 해상도 | 화면 폭 비율 | 화면 높이 비율 | 특징 |
|--------|------------|--------------|------|
| **480p** | 70% | 55vh | 컴팩트한 중앙 정렬 |
| **720p** | 95% | 75vh | 큰 화면 활용 |

## 🎨 UI 디자인 특징

### 전체 화면 활용
- **body**: `min-height: 100vh`, flexbox 레이아웃으로 뷰포트 전체 사용
- **container**: `height: 100vh`로 브라우저 전체 높이 활용
- **video-container**: `flex: 1`로 남은 공간 최대 활용

### 반응형 비디오 영역
- **480p 모드**: `max-width: 70%`, `max-height: 55vh` - 중앙 정렬 컴팩트
- **720p 모드**: `max-width: 95%`, `max-height: 75vh` - 대형 화면 활용
- **object-fit: contain**: 비율 유지하면서 최대 크기 표시

### 사용자 친화적 컨트롤
- **선택된 버튼**: 그린 배경 (#28a745), 흰색 텍스트
- **일반 버튼**: 화이트 그레이 배경 (#f8f9fa), 진한 회색 텍스트
- **실시간 상태 업데이트**: 1초마다 통계 갱신

## 🔧 기술 구현 세부사항

### FastAPI 기반 백엔드
```python
# 주요 엔드포인트
GET  /                 # 메인 웹 인터페이스
GET  /stream          # MJPEG 스트림
POST /switch/{cam_id} # 카메라 전환
POST /api/resolution/{res} # 해상도 변경
GET  /api/stats       # 실시간 통계
```

### 프로세스 관리
- **안전한 카메라 전환**: 기존 프로세스 SIGTERM 후 새 프로세스 시작
- **완전한 정리**: stdout/stderr 버퍼 정리, 프로세스 대기
- **통계 초기화**: 카메라 전환 시 프레임 카운터 리셋

### 스트림 최적화
- **해상도별 동적 설정**: 480p/720p별 최적화된 버퍼 크기
- **프레임 크기 검증**: 유효한 JPEG 프레임만 전송
- **메모리 버퍼 관리**: 동적 크기 제한으로 메모리 누수 방지

## 📁 프로젝트 구조

```
livecam/
├── README.md              # 사용자 가이드 (이 문서)
├── CLAUDE.md             # 개발자 기술 문서  
├── main.py               # 메인 스트리밍 서버 ⭐
├── venv/                 # Python 가상환경
└── src/                  # 기타 소스코드
    └── streaming/        # 레거시 스트리밍 서버들
```

## 🛠️ 문제 해결

### 포트 충돌 문제
```bash
# 포트 사용 프로세스 확인
sudo lsof -i :8001

# 프로세스 종료
sudo kill [PID]
```

### 카메라 인식 문제
```bash
# 카메라 모듈 재시작
sudo modprobe -r bcm2835-v4l2
sudo modprobe bcm2835-v4l2

# 권한 확인
sudo usermod -a -G video $USER
# 로그아웃 후 재로그인 필요
```

### 스트리밍 품질 조정
```python
# main.py에서 품질 파라미터 수정
"--quality", "80",        # 60-95 범위에서 조정
"--framerate", "30",      # 15-30 범위에서 조정  
"--bitrate", "0",         # 0=자동, 수동 설정 가능
```

## 🔄 향후 개발 계획

### 단기 계획 (1-2주)
- [ ] 자동 해상도 감지 및 최적 설정
- [ ] 녹화 기능 통합 (스트리밍과 동시)
- [ ] 더 많은 해상도 지원 (1080p)

### 중기 계획 (1-2개월)
- [ ] 모바일 최적화 반응형 UI
- [ ] 웹RTC 기반 저지연 스트리밍
- [ ] 카메라 설정 실시간 조정 (밝기, 대비 등)

### 장기 계획 (3-6개월)
- [ ] AI 기반 모션 감지 및 알림
- [ ] 클라우드 스트리밍 연동
- [ ] 다중 라즈베리파이 중앙 관제 시스템

## ⚠️ 주의사항

### 시스템 제약
- **단일 카메라 모드**: 한 번에 하나의 카메라만 스트리밍
- **리소스 관리**: 카메라 전환 시 2초 대기 시간 필요
- **포트 설정**: 기본 포트 8001 사용 (변경 가능)

### 성능 최적화 권장사항
- **SD 카드**: Class 10 이상 고속 카드 사용
- **전원**: 5V/3A 안정적 전원 공급
- **냉각**: 장시간 운영 시 방열 고려
- **네트워크**: 유선 연결 권장 (Wi-Fi도 지원)

## 📞 지원 및 문의

- **GitHub**: 이슈 리포트 및 기능 요청
- **개발자**: 기술 문의 및 커스터마이징
- **문서**: CLAUDE.md에서 상세 기술 정보 확인

---

## 🚀 사용법 요약

### 1. 서버 실행
```bash
python main.py
```

### 2. 웹 접속
```
http://라즈베리파이_IP:8001
```

### 3. 기능 사용
- **카메라 전환**: 카메라 0/1 버튼 클릭
- **해상도 변경**: 480p/720p 버튼 클릭
- **실시간 모니터링**: 상태 정보 자동 업데이트

### 4. 최적 사용 시나리오
- **보안 모니터링**: 전방/후방 카메라 실시간 전환 감시
- **라이브 스트리밍**: 상황에 맞는 해상도 선택
- **원격 모니터링**: 웹 브라우저로 어디서나 접속

🎯 **핵심 장점**: 시스템 부하 최소화하면서 듀얼 카메라의 유연성을 모두 활용할 수 있는 스마트한 토글 시스템입니다!